// =================================================================
// FunÃ§Ãµes de WhatsApp para o assistente A.L.F.R.E.D.
// =================================================================

// =================================================================
// FunÃ§Ã£o para registrar logs de mensagens
// =================================================================
function registrarLogMensagem(tipo, numero, mensagem, sucesso = true) {
  try {
    const planilha = SpreadsheetApp.openById(PLANILHA_ID);
    const abaLogs = planilha.getSheetByName('Logs de Mensagens') || planilha.insertSheet('Logs de Mensagens');
    
    // Se a aba for nova, adicionar cabeÃ§alhos
    if (abaLogs.getLastRow() === 0) {
      abaLogs.appendRow(['Data/Hora', 'NÃºmero', 'Tipo', 'Mensagem', 'Status']);
      abaLogs.getRange(1, 1, 1, 5).setFontWeight('bold');
    }
    
    // Registrar a mensagem
    const agora = new Date();
    const status = sucesso ? 'Sucesso' : 'Falha';
    abaLogs.appendRow([agora, numero, tipo, mensagem, status]);
    
    Logger.log('âœ… Log de mensagem registrado: %s, %s, %s', tipo, numero, status);
    return true;
  } catch (e) {
    Logger.log('âŒ Erro ao registrar log de mensagem: %s', e);
    Logger.log('âŒ Stack trace: %s', e.stack);
    return false;
  }
}

// =================================================================
// FunÃ§Ã£o para personalizar a resposta com emojis e dicas contextuais
// =================================================================
function personalizarResposta(interpret) {
  let msg = interpret.mensagem || "";
  const dados = interpret.dados || {};
  const valor = dados.valor ? parseFloat(dados.valor) : 0;
  const descricao = (dados.descricao || "").toLowerCase();
  
  // Obter hora atual para personalizaÃ§Ã£o por perÃ­odo do dia
  const agora = new Date();
  const hora = agora.getHours();
  let saudacao = "";
  
  // Definir saudaÃ§Ã£o baseada no perÃ­odo do dia
  if (hora >= 5 && hora < 12) {
    saudacao = "â˜€ï¸ ";  // ManhÃ£
  } else if (hora >= 12 && hora < 18) {
    saudacao = "ğŸŒ¤ï¸ ";  // Tarde
  } else if (hora >= 18 && hora < 23) {
    saudacao = "ğŸŒ™ ";  // Noite
  } else {
    saudacao = "ğŸŒ  ";  // Madrugada
  }
  
  // Lista expandida de emojis para categorias
  const emojisPorCategoria = {
    "transporte": "ğŸš—ğŸ›£ï¸",
    "alimentaÃ§Ã£o": "ğŸ½ï¸ğŸ¥—",
    "saÃºde": "ğŸ¥â¤ï¸",
    "entretenimento": "ğŸ¬ğŸ­",
    "investimento": "ğŸ“ˆğŸ’",
    "freelancer": "ğŸ’¼ğŸš€",
    "educaÃ§Ã£o": "ğŸ“šğŸ§ ",
    "moradia": "ğŸ ğŸ”‘",
    "vestuÃ¡rio": "ğŸ‘”ğŸ‘Ÿ",
    "viagem": "âœˆï¸ğŸŒ´",
    "tecnologia": "ğŸ’»ğŸ“±",
    "presente": "ğŸğŸŠ",
    "default": "ğŸ’°âœ¨"
  };

  // AÃ§Ãµes especÃ­ficas com personalizaÃ§Ã£o aprimorada
  if (interpret.acao === "registrar_receita") {
    // Emojis para receitas
    let emojisReceita = "âœ¨ğŸ’°";
    
    // PersonalizaÃ§Ã£o por palavras-chave na descriÃ§Ã£o
    if (descricao.includes("salÃ¡rio")) {
      emojisReceita = "ğŸ’¼ğŸ’¸";
      msg = `${saudacao}${emojisReceita} SalÃ¡rio registrado! Seu esforÃ§o recompensado.`;
    } else if (descricao.includes("freelance") || descricao.includes("extra")) {
      emojisReceita = "ğŸš€ğŸ’ª";
      msg = `${saudacao}${emojisReceita} Receita extra registrada! Seu esforÃ§o adicional valeu a pena!`;
    } else if (descricao.includes("investimento") || descricao.includes("rendimento")) {
      emojisReceita = "ğŸ“ˆğŸ’";
      msg = `${saudacao}${emojisReceita} Rendimento registrado! Seu dinheiro trabalhando para vocÃª.`;
    } else {
      // PersonalizaÃ§Ã£o por valor
      if (valor > 1000) {
        msg = `${saudacao}${emojisReceita} Receita significativa registrada! Excelente conquista!`;
      } else {
        msg = `${saudacao}${emojisReceita} Receita registrada! Cada entrada positiva conta.`;
      }
    }
  } 
  else if (interpret.acao === "registrar_despesa") {
    // Obter categoria e emojis correspondentes
    const categoria = (dados.categoria || "").toLowerCase();
    const emojis = emojisPorCategoria[categoria] || emojisPorCategoria["default"];
    
    // Mensagem base com emojis da categoria
    msg = `${saudacao}${emojis} Despesa registrada!`;
    
    // Adicionar comentÃ¡rio baseado no valor
    if (valor > 500) {
      msg += " Lembre-se de revisar gastos maiores regularmente.";
    }
    
    // PersonalizaÃ§Ã£o por categoria especÃ­fica
    if (categoria === "alimentaÃ§Ã£o") {
      msg = `${saudacao}${emojis} Despesa alimentar registrada! NutriÃ§Ã£o Ã© investimento.`;
    } else if (categoria === "transporte") {
      msg = `${saudacao}${emojis} Despesa de transporte registrada! Mobilidade garantida.`;
    } else if (categoria === "saÃºde") {
      msg = `${saudacao}${emojis} Despesa de saÃºde registrada! Cuidar-se Ã© prioridade.`;
    } else if (categoria === "educaÃ§Ã£o") {
      msg = `${saudacao}${emojis} Investimento em educaÃ§Ã£o registrado! Conhecimento Ã© poder.`;
    }
    
    // PersonalizaÃ§Ã£o por palavras-chave na descriÃ§Ã£o
    if (descricao.includes("freelancer") || descricao.includes("trabalho")) {
      msg += " Investir no trabalho sempre traz retorno!";
    }
  } 
  else if (interpret.acao === "consultar_saldo") {
    msg = `${saudacao}ğŸ“ŠğŸ’° Saldo atual: R$ ${valor}! Controle financeiro Ã© liberdade.`;
    
    // PersonalizaÃ§Ã£o por valor do saldo
    if (valor < 0) {
      msg = `${saudacao}âš ï¸ğŸ“Š AtenÃ§Ã£o! Saldo negativo: R$ ${valor}. Vamos reverter isso!`;
    } else if (valor < 100) {
      msg = `${saudacao}ğŸ“Šâš ï¸ Saldo atual: R$ ${valor}. AtenÃ§Ã£o aos prÃ³ximos gastos!`;
    } else if (valor > 1000) {
      msg = `${saudacao}ğŸ“ŠğŸ¯ Saldo saudÃ¡vel: R$ ${valor}! Excelente gestÃ£o financeira!`;
    }
  } 
  else if (interpret.acao === "adicionar_compromisso") {
    msg = `${saudacao}ğŸ“…âœ… Compromisso agendado! OrganizaÃ§Ã£o Ã© produtividade.`;
    
    // PersonalizaÃ§Ã£o por tipo de compromisso
    if (descricao.includes("reuniÃ£o") || descricao.includes("trabalho")) {
      msg = `${saudacao}ğŸ’¼ğŸ“… Compromisso profissional agendado! PreparaÃ§Ã£o Ã© sucesso.`;
    } else if (descricao.includes("mÃ©dico") || descricao.includes("saÃºde")) {
      msg = `${saudacao}â¤ï¸ğŸ¥ Consulta agendada! SaÃºde em primeiro lugar.`;
    } else if (descricao.includes("pagamento") || descricao.includes("conta")) {
      msg = `${saudacao}ğŸ’°ğŸ“† Pagamento agendado! Suas finanÃ§as organizadas.`;
    }
  }
  
  return msg;
}

// =================================================================
// AtualizaÃ§Ã£o da funÃ§Ã£o processarMensagem para usar a resposta personalizada
// =================================================================
function processarMensagem(numero, mensagem) {
  try {
    Logger.log('ğŸ”„ Iniciando processamento para nÃºmero: %s', numero);
  
    let interpret;
    try {
      interpret = interpretarComGPT4(mensagem);
      Logger.log('ğŸ“¤ AÃ§Ã£o identificada: %s, dados: %s', interpret.acao, JSON.stringify(interpret.dados));
    } catch (e) {
      Logger.log('âŒ Erro ao interpretar mensagem: %s', e);
      enviarMensagemWhatsApp(numero, `âŒ Erro de interpretaÃ§Ã£o: ${e.message}`);
      return;
    }
  
    Logger.log('ğŸ”€ Executando aÃ§Ã£o: %s', interpret.acao);
  
    // Gera a mensagem personalizada, enriquecida com emojis e dicas
    const respostaPersonalizada = personalizarResposta(interpret);
  
    switch (interpret.acao) {
      case 'registrar_despesa':
        if (!interpret.dados.valor) {
          Logger.log('âš ï¸ Valor ausente para despesa');
          enviarMensagemWhatsApp(numero, 'âš ï¸ Para registrar a despesa, informe um valor vÃ¡lido.');
        } else {
          Logger.log('ğŸ’¾ Registrando despesa: %s', JSON.stringify(interpret.dados));
          try {
            registrarDespesa(interpret.dados);
            Logger.log('âœ… Despesa registrada com sucesso');
            enviarMensagemWhatsApp(numero, respostaPersonalizada);
          } catch (e) {
            Logger.log('âŒ Erro ao registrar despesa: %s', e);
            enviarMensagemWhatsApp(numero, `âŒ Erro ao registrar despesa: ${e.message}`);
          }
        }
        break;
  
      case 'registrar_receita':
        if (!interpret.dados.valor) {
          Logger.log('âš ï¸ Valor ausente para receita');
          enviarMensagemWhatsApp(numero, 'âš ï¸ Para registrar a receita, informe um valor vÃ¡lido.');
        } else {
          Logger.log('ğŸ’¾ Registrando receita: %s', JSON.stringify(interpret.dados));
          try {
            registrarReceita(interpret.dados);
            Logger.log('âœ… Receita registrada com sucesso');
            enviarMensagemWhatsApp(numero, respostaPersonalizada);
          } catch (e) {
            Logger.log('âŒ Erro ao registrar receita: %s', e);
            enviarMensagemWhatsApp(numero, `âŒ Erro ao registrar receita: ${e.message}`);
          }
        }
        break;
  
      case 'consultar_saldo':
        Logger.log('ğŸ’° Consultando saldo...');
        try {
          const saldo = consultarSaldo();
          Logger.log('ğŸ“Š Saldo consultado: R$ %s', saldo);
          // Atualizar o interpret com o valor do saldo para personalizaÃ§Ã£o
          interpret.dados = interpret.dados || {};
          interpret.dados.valor = saldo;
          const respostaComSaldo = personalizarResposta(interpret);
          enviarMensagemWhatsApp(numero, respostaComSaldo);
        } catch (e) {
          Logger.log('âŒ Erro ao consultar saldo: %s', e);
          enviarMensagemWhatsApp(numero, `âŒ Erro ao consultar saldo: ${e.message}`);
        }
        break;
  
      case 'adicionar_compromisso':
        if (!interpret.dados.data || !interpret.dados.hora) {
          Logger.log('âš ï¸ Data/hora ausentes para compromisso');
          enviarMensagemWhatsApp(numero, 'âš ï¸ Informe a data e a hora para agendar o compromisso.');
        } else {
          Logger.log('ğŸ“… Adicionando compromisso: %s', JSON.stringify(interpret.dados));
          try {
            adicionarCompromisso(interpret.dados);
            Logger.log('âœ… Compromisso registrado na planilha');
            try {
              adicionarEventoCalendario(interpret.dados);
              Logger.log('âœ… Compromisso registrado no Google Calendar');
              enviarMensagemWhatsApp(numero, respostaPersonalizada);
            } catch (calendarError) {
              Logger.log('âš ï¸ Erro ao adicionar no Google Calendar: %s', calendarError);
              enviarMensagemWhatsApp(numero, respostaPersonalizada + ' (Falha ao sincronizar com o Calendar)');
            }
          } catch (e) {
            Logger.log('âŒ Erro ao registrar compromisso: %s', e);
            enviarMensagemWhatsApp(numero, `âŒ Erro ao registrar compromisso: ${e.message}`);
          }
        }
        break;
  
      default:
        Logger.log('ğŸ¤” Comando nÃ£o reconhecido. Texto livre retornado: %s', respostaPersonalizada);
        enviarMensagemWhatsApp(numero, respostaPersonalizada || 'ğŸ¤– Desculpe, nÃ£o entendi. Tente reformular sua mensagem.');
    }
  
  } catch (e) {
    Logger.log('âŒ Erro geral no processamento: %s', e);
    Logger.log('ğŸ“› Stack trace:\n%s', e.stack);
    try {
      enviarMensagemWhatsApp(numero, `âŒ Erro no processamento da mensagem: ${e.message}`);
    } catch (sendError) {
      Logger.log('âŒ Falha ao enviar mensagem de erro: %s', sendError);
    }
  }
}

// =================================================================
// Teste de comunicaÃ§Ã£o Twilio
// =================================================================
function simularRecebimentoMensagem(numero, mensagem) {
  try {
    Logger.log('ğŸ”„ Simulando recebimento de mensagem');
    Logger.log('ğŸ“± NÃºmero: %s', numero);
    Logger.log('ğŸ’¬ Mensagem: %s', mensagem);
    
    // Formata o nÃºmero para o formato esperado pelo webhook
    const numeroFormatado = numero.startsWith('+') ? numero : `+${numero}`;
    const fromFull = `whatsapp:${numeroFormatado}`;
    
    // Simula o objeto de parÃ¢metros do webhook
    const e = {
      parameter: {
        From: fromFull,
        Body: mensagem
      }
    };
    
    // Chama a funÃ§Ã£o doPost como se fosse um webhook real
    Logger.log('ğŸ“¤ Chamando doPost com parÃ¢metros simulados');
    const response = doPost(e);
    
    Logger.log('âœ… SimulaÃ§Ã£o concluÃ­da');
    return { success: true, response };
  } catch (e) {
    Logger.log('âŒ Erro na simulaÃ§Ã£o de recebimento de mensagem: %s', e);
    Logger.log('âŒ Stack trace: %s', e.stack);
    return { success: false, error: e.toString() };
  }
}

// =================================================================
// FunÃ§Ã£o para testar a personalizaÃ§Ã£o de respostas
// =================================================================
function testarPersonalizacaoRespostas() {
  try {
    Logger.log('ğŸ”„ Iniciando teste de personalizaÃ§Ã£o de respostas');
    
    // Testar diferentes tipos de aÃ§Ãµes
    const testes = [
      {
        nome: "Despesa simples",
        interpret: {
          acao: "registrar_despesa",
          dados: {
            valor: 50,
            categoria: "alimentaÃ§Ã£o",
            descricao: "AlmoÃ§o"
          },
          mensagem: "Despesa registrada com sucesso"
        }
      },
      {
        nome: "Despesa grande",
        interpret: {
          acao: "registrar_despesa",
          dados: {
            valor: 800,
            categoria: "tecnologia",
            descricao: "Novo celular"
          },
          mensagem: "Despesa registrada com sucesso"
        }
      },
      {
        nome: "Receita salÃ¡rio",
        interpret: {
          acao: "registrar_receita",
          dados: {
            valor: 3000,
            categoria: "salÃ¡rio",
            descricao: "SalÃ¡rio mensal"
          },
          mensagem: "Receita registrada com sucesso"
        }
      },
      {
        nome: "Consulta saldo",
        interpret: {
          acao: "consultar_saldo",
          dados: {
            valor: 1500
          },
          mensagem: "Seu saldo atual Ã© de R$ 1500"
        }
      },
      {
        nome: "Compromisso mÃ©dico",
        interpret: {
          acao: "adicionar_compromisso",
          dados: {
            data: "10/06/2023",
            hora: "14:30",
            descricao: "Consulta mÃ©dica"
          },
          mensagem: "Compromisso agendado com sucesso"
        }
      }
    ];
    
    // Executar os testes
    const resultados = [];
    for (const teste of testes) {
      Logger.log('ğŸ§ª Testando personalizaÃ§Ã£o: %s', teste.nome);
      const resposta = personalizarResposta(teste.interpret);
      Logger.log('ğŸ“ Resposta original: %s', teste.interpret.mensagem);
      Logger.log('ğŸ“ Resposta personalizada: %s', resposta);
      resultados.push({
        teste: teste.nome,
        original: teste.interpret.mensagem,
        personalizada: resposta,
        sucesso: resposta !== teste.interpret.mensagem
      });
    }
    
    // Exibir resultados
    Logger.log('ğŸ“Š Resultados dos testes de personalizaÃ§Ã£o:');
    for (const resultado of resultados) {
      Logger.log('- %s: %s', resultado.teste, resultado.sucesso ? 'Sucesso âœ…' : 'Falha âŒ');
    }
    
    return resultados;
  } catch (e) {
    Logger.log('âŒ Erro no teste de personalizaÃ§Ã£o: %s', e);
    Logger.log('âŒ Stack trace: %s', e.stack);
    return { success: false, error: e.toString() };
  }
}
